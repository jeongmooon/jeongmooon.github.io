<hr />

# SQL Injection

## SQL Injection이란?
`SQL Injection`은 **응용 프로그램의 보안 허점을 의도적으로 이용**하여, 악의적인 SQL문을 실행하게 함으로써 데이터베이스를 비정상적으로 조작하는 **코드 인젝션 공격 방법**이다.<br>
공격자는 기존 SQL 쿼리에 논리 표현식이나 추가 명령어를 삽입하여 조작하여 공격을 한다.<br><br>

`SQL Injection`은 2010년 이후 웹사이트 공격 방식 중 1위로 평가되었으며, 현재도 많은 웹사이트들이 여전히 이런 공격에 **취약**하고 보안에 큰 위협 중 하나다.

---

## 취약점의 원인
- SQL 인젝션 취약점은 사용자로부터 입력받거나 클라이언트 측에서 데이터베이스에 적용되는 입력값이 제대로 `유효성 검증`되지 않았을 때 발생한다. 

- 가장 중요한 것은 **개발자는 사용자의 입력값을 절대로 신뢰해서는 안된 다는 것**이다. 사용자 입력 데이터가 애플리케이션에 의해 제대로 검증되지 않고 SQL 쿼리와 문자열로 붙여질 때 해킹 공격이 가능해진다.

---

## 공격 기법
공격자는 취약점을 이용해 다양한 방식으로 시스템에 침투하거나 정보를 탈취 한다.

- **로그인 우회:**
    - 사용자 이름이나 비밀번호 입력 필드에 `' or 1=1 --`와 같은 악의적인 문자열을 삽입한다. <br>이로 인해 SQL은 (SELECT * FROM users WHERE username='`' or 1=1 --`' AND password='INPUT')의 논리 조건이 항상 참이 되도록 조작하여 비밀번호 없이도 로그인을 성공시킨다.

- **URL 조작:**
    - URL 쿼리스트링(`?id=1`등)를 조작하여 백앤드 쿼리에 악성 쿼리를 넣을 수도 있다.
    - URL에 `'` 또는 `"`를 추가하여 에러를 유발하고 취약점점을 확인하는데 사용된다.

- **데이터 탈취 및 조작:**
    - SQL Injection을 통해 데이터베이스 레코드를 가지고오고 이를 변경하여 새로운 관리자 계정 생성 혹은 권한 부여 작업이 가능해진다.

- **Blind SQL 삽입:**
    - 웹사이트가 SQL 삽입에 취약하지만 데이터베이스 오류 메시지가 공격자에게 보이지 않을 때 사용되는 기법이다.
    - 쿼리가 참일 때와 거짓일 때의 서버의 반응(페이지 내용 혹은 로딩 시간등)을 체크하여 한 글자 씩 혹은 한 비트씩 추출한다.

- **파일 시스템 접근 및 웹쉘 업로드 (MySQL):**
    - Mysql에는 파일 읽기(load_file()) 및 파일 쓰기(INTO OUTFILE) 기능이 있는데 이 기능을 SQL Injection과 같이 활용하여 서버에 임의의 파일을 만들어서 읽게하여 해킹하는 방법이다.
    - 이를 위해서는 데이터베이스 사용자에게 **FILE 권한**이 부여되어 있어야 한다.

- **주요 공격 관련 용어/기법:**
    - ``UNION SELECT``: 여러 SELECT 문의 결과를 합치는 데 사용되지만, 공격 시 악의적인 SELECT 문을 합치는 데 악용
        - 예시) 로그인 우회를 예시로 SELECT USER_ID,PASS FROM USER_INFO WHERE USER_ID = '`1 AND 1=2' UNION SELECT '로그인 아이디', '내가 입력한 비밀번호'/*` ' 입력 하여 PASS 컬럼을 조회 하여 확인할 때 앞에 아이디 조회 시에는 조건으로 거짓을 만들어 빈 값을 받고 내가 원하는 값을 입력하여 공격한다.

    - ``ORDER BY`` : 컬럼 수를 추측하는데 사용
        - 예시) SELECT USER_ID FROM USER_INFO WHERE USER_ID = ':id`' ORDER BY 1/*` ' AND PASS = :pass
        - 설명) 정상적인 아이디와 패스워드를 준비 후에 뒤에 'ORDER BY `1`(이 곳에서 숫자는 컬럼의 위치를 의미) /* 를 추가하여 정상적으로 작동하는지 확인한다. 정상적으로 작동한다면 입력한 숫자 값 만큼의 컬럼이 존재한다는 것을 의미

    - `--`, `#`, `/*` : SQL에서 주석을 시작하는 구문으로, 쿼리의 나머지 부분을 무효화 시키는데 사용
        - 예시) SELECT USER_ID FROM USER_INFO WHERE USER_ID = '`admin' /*` ' AND PASS = 1

    - `information_schema` : 표준 메타데이터 데이터베이스이다. 데이터 베이스에 대한 정보(스카마, 구조)를 저장하는 특수한 시스템 데이터 베이스
        - 일반적으로 페이지나 파라미터 출력이 있는 곳을 공략한다.
        - 파라미터 출력이 되는 곳이 없다면 해당 방식으로도 확인이 가능하다.
            - 참/거짓의 응답 반응으로 하나 씩 체크
                - `AND (SELECT COUNT(*) FROM information_schema.tables WHERE table_name LIKE '찾는 문자열') > 1 -- ` 한글자 씩 찾아서 공격
        - 여러 방식으로 응용이 가능하다.

---

## 방어 방법
SQL Injection은 효과적으로 방어 방법이 존재하며,여러 계층의 보안 조치로 적용하는 것이 중요하다.<br>

- **Prepared Statement:**
    - 가장 권장되는 방법 중 하나로 SQL 쿼리 자체와 사용자의 입력 값을 분리하여 처리가 된다.
    - 쿼리 템플릿이 먼저 데이터베이스에 전송되어 분석 및 최적화가 되고, 후에 사용자 입력 값은 매개변수로써 별도로 바인딩되어 실행이 된다.

- **Escaping:**
    - SQL에서 특별한 의미를 가지고 있는 문자(`'`등) 앞에 `\`를 붙여서 일반 문자로 처리하는 방법이다.
    - 보조용으로 사용은 권장되지만 데이터베이스 별로 규칙이 다르면 문제가 생길수도 있다.

- **Database Firewall:**
    - 데이터베이스 방화벽으로 악의적인 SQL 명령어를 차단하거나 위험도를 계산하여 특정 쿼리 구문을 차단 할 수 있다.
    - 최종 방어선 역할로 취약한 레거시 시스템 보호에 효율적일 수는 있지만 근본적인 해결 방법은 아니다.
    - 또한 정교한 인젝션은 우회가 가능 할 수 있다.

- **최소 권한 원칙 적용:**
    - 애플리케이션에서 데이터베이스에 접근 할 때 `root권한 사용자 같은 관리자 계정`을 사용하지 않아야 한다.

- **FILE 권한 회수:**
    - 애플리케이션 사용자가 불필요하게 `FILE 권한`을 가지지 않도록 회수해야 한다.

- **Server-Side Validation:**
    - 가장 기본적인 것으로 개발자가 사용자 입력 값을 신뢰하지 않고 데이터를 검증해야한다.
    - 블랙리스트나 화이트 리스트 검증이 예시로 될 수 있다.

---
## 결론
`SQL Injection`은 상위 위협으로 분류 되어 있고, 사용자 입력에 대한 부적절한 처리라는 기본적인 **취약점**이 여전히 존재한다.<br>
이를 통해 데이터 탈취부터 서버 제어권 획득까지 가능한 심각한 공격 기법들이 사용될 수 있기 때문이다.<br>
따라서 이러한 취약점을 해결하고 위에 나열된 보안 기법들을 적용하는 것이 애플리케이션 보안에서 매우 중요하다.

<hr />